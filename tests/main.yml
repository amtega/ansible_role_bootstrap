---
# Tasks for testing role

- name: run idempotence test
  hosts: localhost
  roles:
    - role: amtega.docker_presets
      docker_presets_images_json_query: >-
        [? starts_with(name, `centos-6`)
           || starts_with(name, `centos-7`)
           || starts_with(name, `fedora-27`)
           || starts_with(name, `fedora-28`) ]

    - role: amtega.docker_sandbox
      docker_sandbox_state: started
  tags:
    - sandbox

- name: test bootstrap role
  hosts: docker_sandbox_containers
  gather_facts: false
  vars:
    ansible_user: testinguser1
    ansible_password: testingpassword1
    ansible_become: true
    ansible_become_method: su
    ansible_become_user: >-
      {{ hostvars[inventory_hostname].ansible_user }}
    ansible_become_pass: >-
      {{ hostvars[inventory_hostname].ansible_password }}
  roles:
    - role: amtega.bootstrap
      bootstrap_enable: true
      bootstrap_ansible_user: >-
        {{ hostvars[inventory_hostname].ansible_user }}
      bootstrap_ansible_password: >-
        {{ hostvars[inventory_hostname].ansible_password }}
  tasks:
    - name: test bootstrap_shadow_facts module with a list of users
      bootstrap_shadow_facts:
        usernames:
          - root
          - daemon
      register: module_result
      failed_when: >-
        "root" not in module_result.shadows
        or "daemon" not in module_result.shadows

    - name: test bootstrap_shadow_match filter
      assert:
        that: password is bootstrap_shadow_match(module_result.shadows.root)
      vars:
        password: "root"

    - name: get ansible user
      getent:
        database: passwd
        key: "{{ ansible_user }}"
      register: get_ansible_user_result

    - name: get ansible become user
      getent:
        database: passwd
        key: "{{ ansible_become_user }}"
      register: get_ansible_become_user_result

    - name: verify ansible users
      assert:
        that:
          - >-
            ansible_user
              in get_ansible_user_result.ansible_facts.getent_passwd
          - >-
            ansible_become_user
              in get_ansible_become_user_result.ansible_facts.getent_passwd
  tags:
    - idempotence

- name: cleanup docker docker sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      docker_sandbox_state: absent
