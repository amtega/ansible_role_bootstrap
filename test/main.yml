---
# Tasks for tesing role

- name: run idempotence test
  hosts: localhost
  roles:
    - role: docker_presets
    - role: docker_sandbox
      docker_sandbox_state: started
      docker_sandbox_idempotence_test: false

- name: test bootstrap role
  hosts: docker_sandbox_containers
  gather_facts: false
  vars:
    ansible_user: testinguser1
    ansible_password: testingpassword1
    ansible_become: true
    ansible_become_method: su
    ansible_become_user: >-
      {{ hostvars[inventory_hostname].ansible_user }}
    ansible_become_pass: >-
      {{ hostvars[inventory_hostname].ansible_password }}
  roles:
    - role: bootstrap
      bootstrap_enable: true
      bootstrap_ansible_user: >-
        {{ hostvars[inventory_hostname].ansible_user }}
      bootstrap_ansible_password: >-
        {{ hostvars[inventory_hostname].ansible_password }}
  tasks:
    - name: get ansible user
      getent:
        database: passwd
        key: "{{ ansible_user }}"
      register: get_ansible_user_result

    - name: get ansible become user
      getent:
        database: passwd
        key: "{{ ansible_become_user }}"
      register: get_ansible_become_user_result

    - name: verify ansible users
      assert:
        that:
          - >-
            ansible_user
              in get_ansible_user_result.ansible_facts.getent_passwd
          - >-
            ansible_become_user
              in get_ansible_become_user_result.ansible_facts.getent_passwd
  tags:
    - idempotence

- name: cleanup docker docker sandbox
  hosts: localhost
  roles:
    - role: docker_sandbox
      docker_sandbox_state: absent
